pipeline {
    agent any
    parameters {
        choice(name: 'RECORDTYPE', choices: ['games', 'movies', 'khmom-scores', 'tfbl-scores'], description: 'Pick a record type')
    }
    stages {
        stage("Build") {
            steps {
                cleanWs()
                script {
                    d = new Date()
                    now = d.format("yyyyMMddHHmmss")
                }
                sh "mkdir records"
                dir("records") {
                    git poll: false,
                        url: 'https://github.com/egartley/records.git'
                }
                dir("records/${params.RECORDTYPE}") {
                    sh "python3 generate-html.py"
                }
                withCredentials([usernamePassword(credentialsId: 'GitHub', usernameVariable: 'USER', passwordVariable: 'PAT')]) {
                    sh '''
                        git clone https://$USER:$PAT@github.com/$USER/net.git
                        cd net
                        git remote set-url origin https://$USER:$PAT@github.com/$USER/net.git
                        git config --global user.email evanmgartley@gmail.com
                        git config --global user.name $USER
                    '''
                }
                dir("net") {
                    sh """
                        git checkout -b jenkins-${now}
                        cp \"../records/${params.RECORDTYPE}/${params.RECORDTYPE}.html\" \"_pages/records/${params.RECORDTYPE}.html\"
                        git add .
                        git commit -m \"Update ${params.RECORDTYPE} records\"
                        git push --set-upstream origin jenkins-${now}
                    """
                }
            }
        }
    }
}
